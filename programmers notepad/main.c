#include <avr/io.h>
#include <util/delay.h>
#include <avr/interrupt.h>
#include "lcd4bit.h"
#include "stdio.h"
#include "stdlib.h"
#define F_CPU 16000000


void sineWave(long tim);
void triWave(long tim);
void squareWave(long tim);
void initModeSw(void);

long FreqRead(void);                 
float AmplitudeRead(void);
//void display(long f, float a,int m);  

void initADC(unsigned char adchan);    
unsigned int readADC(void);

///sin wave points in 8bit//
int sin8bit[] = {0b01111111, 0b10000001, 0b10000011, 0b10000110, 0b10001000, 0b10001010, 0b10001100, 0b10001111, 0b10010001, 0b10010011, 0b10010101, 0b10010111, 0b10011010, 0b10011100, 0b10011110, 0b10100000, 0b10100010, 0b10100100, 0b10100110, 0b10101001, 0b10101011, 0b10101101, 0b10101111, 0b10110001, 0b10110011, 0b10110101, 0b10110111, 0b10111001, 0b10111011, 0b10111101, 0b10111111, 0b11000001, 0b11000011, 0b11000100, 0b11000110, 0b11001000, 0b11001010, 0b11001100, 0b11001101, 0b11001111, 0b11010001, 0b11010011, 0b11010100, 0b11010110, 0b11011000, 0b11011001, 0b11011011, 0b11011100, 0b11011110, 0b11011111, 0b11100001, 0b11100010, 0b11100011, 0b11100101, 0b11100110, 0b11100111, 0b11101001, 0b11101010, 0b11101011, 0b11101100, 0b11101101, 0b11101111, 0b11110000, 0b11110001, 0b11110010, 0b11110011, 0b11110011, 0b11110100, 0b11110101, 0b11110110, 0b11110111, 0b11111000, 0b11111000, 0b11111001, 0b11111010, 0b11111010, 0b11111011, 0b11111011, 0b11111100, 0b11111100, 0b11111101, 0b11111101, 0b11111101, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111111, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111101, 0b11111101, 0b11111101, 0b11111100, 0b11111100, 0b11111011, 0b11111011, 0b11111010, 0b11111010, 0b11111001, 0b11111000, 0b11111000, 0b11110111, 0b11110110, 0b11110101, 0b11110100, 0b11110011, 0b11110011, 0b11110010, 0b11110001, 0b11110000, 0b11101111, 0b11101101, 0b11101100, 0b11101011, 0b11101010, 0b11101001, 0b11100111, 0b11100110, 0b11100101, 0b11100011, 0b11100010, 0b11100001, 0b11011111, 0b11011110, 0b11011100, 0b11011011, 0b11011001, 0b11011000, 0b11010110, 0b11010100, 0b11010011, 0b11010001, 0b11001111, 0b11001101, 0b11001100, 0b11001010, 0b11001000, 0b11000110, 0b11000100, 0b11000011, 0b11000001, 0b10111111, 0b10111101, 0b10111011, 0b10111001, 0b10110111, 0b10110101, 0b10110011, 0b10110001, 0b10101111, 0b10101101, 0b10101011, 0b10101001, 0b10100110, 0b10100100, 0b10100010, 0b10100000, 0b10011110, 0b10011100, 0b10011010, 0b10010111, 0b10010101, 0b10010011, 0b10010001, 0b10001111, 0b10001100, 0b10001010, 0b10001000, 0b10000110, 0b10000011, 0b10000001, 0b01111111, 0b01111101, 0b01111011, 0b01111000, 0b01110110, 0b01110100, 0b01110010, 0b01101111, 0b01101101, 0b01101011, 0b01101001, 0b01100111, 0b01100100, 0b01100010, 0b01100000, 0b01011110, 0b01011100, 0b01011010, 0b01011000, 0b01010101, 0b01010011, 0b01010001, 0b01001111, 0b01001101, 0b01001011, 0b01001001, 0b01000111, 0b01000101, 0b01000011, 0b01000001, 0b00111111, 0b00111101, 0b00111011, 0b00111010, 0b00111000, 0b00110110, 0b00110100, 0b00110010, 0b00110001, 0b00101111, 0b00101101, 0b00101011, 0b00101010, 0b00101000, 0b00100110, 0b00100101, 0b00100011, 0b00100010, 0b00100000, 0b00011111, 0b00011101, 0b00011100, 0b00011011, 0b00011001, 0b00011000, 0b00010111, 0b00010101, 0b00010100, 0b00010011, 0b00010010, 0b00010001, 0b00001111, 0b00001110, 0b00001101, 0b00001100, 0b00001011, 0b00001011, 0b00001010, 0b00001001, 0b00001000, 0b00000111, 0b00000110, 0b00000110, 0b00000101, 0b00000100, 0b00000100, 0b00000011, 0b00000011, 0b00000010, 0b00000010, 0b00000001, 0b00000001, 0b00000001, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001, 0b00000001, 0b00000001, 0b00000010, 0b00000010, 0b00000011, 0b00000011, 0b00000100, 0b00000100, 0b00000101, 0b00000110, 0b00000110, 0b00000111, 0b00001000, 0b00001001, 0b00001010, 0b00001011, 0b00001011, 0b00001100, 0b00001101, 0b00001110, 0b00001111, 0b00010001, 0b00010010, 0b00010011, 0b00010100, 0b00010101, 0b00010111, 0b00011000, 0b00011001, 0b00011011, 0b00011100, 0b00011101, 0b00011111, 0b00100000, 0b00100010, 0b00100011, 0b00100101, 0b00100110, 0b00101000, 0b00101010, 0b00101011, 0b00101101, 0b00101111, 0b00110001, 0b00110010, 0b00110100, 0b00110110, 0b00111000, 0b00111010, 0b00111011, 0b00111101, 0b00111111, 0b01000001, 0b01000011, 0b01000101, 0b01000111, 0b01001001, 0b01001011, 0b01001101, 0b01001111, 0b01010001, 0b01010011, 0b01010101, 0b01011000, 0b01011010, 0b01011100, 0b01011110, 0b01100000, 0b01100010, 0b01100100, 0b01100111, 0b01101001, 0b01101011, 0b01101101, 0b01101111, 0b01110010, 0b01110100, 0b01110110, 0b01111000, 0b01111011, 0b01111101};
///triangle wave points in 8bit//
int tri8bit[] = {0b00000000, 0b00000001, 0b00000010, 0b00000100, 0b00000101, 0b00000111, 0b00001000, 0b00001001, 0b00001011, 0b00001100, 0b00001110, 0b00001111, 0b00010001, 0b00010010, 0b00010011, 0b00010101, 0b00010110, 0b00011000, 0b00011001, 0b00011010, 0b00011100, 0b00011101, 0b00011111, 0b00100000, 0b00100010, 0b00100011, 0b00100100, 0b00100110, 0b00100111, 0b00101001, 0b00101010, 0b00101011, 0b00101101, 0b00101110, 0b00110000, 0b00110001, 0b00110011, 0b00110100, 0b00110101, 0b00110111, 0b00111000, 0b00111010, 0b00111011, 0b00111100, 0b00111110, 0b00111111, 0b01000001, 0b01000010, 0b01000100, 0b01000101, 0b01000110, 0b01001000, 0b01001001, 0b01001011, 0b01001100, 0b01001101, 0b01001111, 0b01010000, 0b01010010, 0b01010011, 0b01010101, 0b01010110, 0b01010111, 0b01011001, 0b01011010, 0b01011100, 0b01011101, 0b01011110, 0b01100000, 0b01100001, 0b01100011, 0b01100100, 0b01100110, 0b01100111, 0b01101000, 0b01101010, 0b01101011, 0b01101101, 0b01101110, 0b01101111, 0b01110001, 0b01110010, 0b01110100, 0b01110101, 0b01110111, 0b01111000, 0b01111001, 0b01111011, 0b01111100, 0b01111110, 0b01111111, 0b10000000, 0b10000010, 0b10000011, 0b10000101, 0b10000110, 0b10001000, 0b10001001, 0b10001010, 0b10001100, 0b10001101, 0b10001111, 0b10010000, 0b10010001, 0b10010011, 0b10010100, 0b10010110, 0b10010111, 0b10011001, 0b10011010, 0b10011011, 0b10011101, 0b10011110, 0b10100000, 0b10100001, 0b10100010, 0b10100100, 0b10100101, 0b10100111, 0b10101000, 0b10101010, 0b10101011, 0b10101100, 0b10101110, 0b10101111, 0b10110001, 0b10110010, 0b10110011, 0b10110101, 0b10110110, 0b10111000, 0b10111001, 0b10111011, 0b10111100, 0b10111101, 0b10111111, 0b11000000, 0b11000010, 0b11000011, 0b11000100, 0b11000110, 0b11000111, 0b11001001, 0b11001010, 0b11001100, 0b11001101, 0b11001110, 0b11010000, 0b11010001, 0b11010011, 0b11010100, 0b11010101, 0b11010111, 0b11011000, 0b11011010, 0b11011011, 0b11011101, 0b11011110, 0b11011111, 0b11100001, 0b11100010, 0b11100100, 0b11100101, 0b11100110, 0b11101000, 0b11101001, 0b11101011, 0b11101100, 0b11101110, 0b11101111, 0b11110000, 0b11110010, 0b11110011, 0b11110101, 0b11110110, 0b11110111, 0b11111001, 0b11111010, 0b11111100, 0b11111101, 0b11111111, 0b11111101, 0b11111100, 0b11111010, 0b11111001, 0b11110111, 0b11110110, 0b11110101, 0b11110011, 0b11110010, 0b11110000, 0b11101111, 0b11101110, 0b11101100, 0b11101011, 0b11101001, 0b11101000, 0b11100110, 0b11100101, 0b11100100, 0b11100010, 0b11100001, 0b11011111, 0b11011110, 0b11011101, 0b11011011, 0b11011010, 0b11011000, 0b11010111, 0b11010101, 0b11010100, 0b11010011, 0b11010001, 0b11010000, 0b11001110, 0b11001101, 0b11001100, 0b11001010, 0b11001001, 0b11000111, 0b11000110, 0b11000100, 0b11000011, 0b11000010, 0b11000000, 0b10111111, 0b10111101, 0b10111100, 0b10111011, 0b10111001, 0b10111000, 0b10110110, 0b10110101, 0b10110011, 0b10110010, 0b10110001, 0b10101111, 0b10101110, 0b10101100, 0b10101011, 0b10101010, 0b10101000, 0b10100111, 0b10100101, 0b10100100, 0b10100010, 0b10100001, 0b10100000, 0b10011110, 0b10011101, 0b10011011, 0b10011010, 0b10011001, 0b10010111, 0b10010110, 0b10010100, 0b10010011, 0b10010001, 0b10010000, 0b10001111, 0b10001101, 0b10001100, 0b10001010, 0b10001001, 0b10001000, 0b10000110, 0b10000101, 0b10000011, 0b10000010, 0b10000000, 0b01111111, 0b01111110, 0b01111100, 0b01111011, 0b01111001, 0b01111000, 0b01110111, 0b01110101, 0b01110100, 0b01110010, 0b01110001, 0b01101111, 0b01101110, 0b01101101, 0b01101011, 0b01101010, 0b01101000, 0b01100111, 0b01100110, 0b01100100, 0b01100011, 0b01100001, 0b01100000, 0b01011110, 0b01011101, 0b01011100, 0b01011010, 0b01011001, 0b01010111, 0b01010110, 0b01010101, 0b01010011, 0b01010010, 0b01010000, 0b01001111, 0b01001101, 0b01001100, 0b01001011, 0b01001001, 0b01001000, 0b01000110, 0b01000101, 0b01000100, 0b01000010, 0b01000001, 0b00111111, 0b00111110, 0b00111100, 0b00111011, 0b00111010, 0b00111000, 0b00110111, 0b00110101, 0b00110100, 0b00110011, 0b00110001, 0b00110000, 0b00101110, 0b00101101, 0b00101011, 0b00101010, 0b00101001, 0b00100111, 0b00100110, 0b00100100, 0b00100011, 0b00100010, 0b00100000, 0b00011111, 0b00011101, 0b00011100, 0b00011010, 0b00011001, 0b00011000, 0b00010110, 0b00010101, 0b00010011, 0b00010010, 0b00010001, 0b00001111, 0b00001110, 0b00001100, 0b00001011, 0b00001001, 0b00001000, 0b00000111, 0b00000101, 0b00000100, 0b00000010, 0b00000001};

int mode = 0;
unsigned int val,ampval;
long val2,freq;
float val1,ampl,ampval2;
//char dispfreq[7], dispampl[7];

int main(void){
	DDRC = 0xff;  //set the port c pins as outputs
	LCDInit(0);   //initialize lcd
	LCDClear();
	
	initModeSw(); // initialize switch
	
	while (1) {
		
		freq = FreqRead();        //read the frequency
		ampl = AmplitudeRead();   //read the amplitude
		
		if(mode==1){
			triWave(freq);
		}
		else if(mode==2){
			squareWave(freq);
		}
		else{ 
			sineWave(freq);
		}
	}
	return 0;
}

float AmplitudeRead(void){        //read the amplitude by pin A6
	initADC(6);
	ampval = readADC();
	ampval2 = ( (ampval/1023.) * (12-0))+0 ;   //set the amplitude 0-12v
	
	return ampval2;
}

long FreqRead(void){            //read the frequency by pin A7
	initADC(7);					
	val = readADC();
	val2 = ( (val/1023.) * (800000-40) ) + 40;   //set the frequency range 40Hz-800000Hz
	
	return val2;
}

void sineWave(long tim){  //sine wave function
	LCDClear();

	LCDWriteStringXY(0,0,"SIGNAL GENERATOR")
	LCDWriteStringXY(0,1,"sinewave");
	LCDWriteStringXY(0,2,"frequency-");
	LCDWriteInt(val2,6);
	LCDWriteStringXY(0,3,"amplitude-");
	LCDWriteInt(ampval2,6);
	
	float t = tim/360.;            
	for (int i=0; i< 360; i++){	//generate sine wave by delay
		PORTC = sin8bit[i];
		_delay_us(t);
	}

}

void triWave(long tim){     //triangular wave function
	LCDClear();

	LCDWriteStringXY(0,0,"SIGNAL GENERATOR")
	LCDWriteStringXY(0,1,"triWave");
	LCDWriteStringXY(0,2,"frequency-");
	LCDWriteInt(val2,6);
	LCDWriteStringXY(0,3,"amplitude-");
	LCDWriteInt(ampval2,6);
	
	float t = tim/360.;	
	for (int i=0; i< 360; i++){	//generate triangular wave by delay
		PORTC = tri8bit[i];
		_delay_us(t);
	}

}

void squareWave(long tim){ //square wave function
	LCDClear();

	LCDWriteStringXY(0,0,"SIGNAL GENERATOR")
	LCDWriteStringXY(0,1,"squareWave");
	LCDWriteStringXY(0,2,"frequency-");
	LCDWriteInt(val2,6);
	LCDWriteStringXY(0,3,"amplitude-");
	LCDWriteInt(ampval2,6);
	
	float t = tim/2.;
	PORTC = 0b11111111;
	_delay_us(t);
	PORTC = 0;
	_delay_us(t);
	
}

ISR(INT0_vect){       ///interuppt for change mode
	if (!(PIND & (1<<PIND2))){  //if button pressed mode change by +1
		mode++;
	}
	if(mode==3){ // after mode=2 it set to 0
		mode = 0;
	}
}

void initModeSw(void){ //initialize pin change interrupt
	DDRD &= ~(1<<INT0);          //int0 set as input
	GICR = 1<<INT0;             //enable external interrupt
	MCUCR = 0<<ISC01 | 1<<ISC00; //request interrupt any logical change
	sei();
}

void initADC(unsigned char adchan){ ///initialize ADC
	DDRA = DDRA &~(1<<adchan);
	ADMUX = 0;
	ADMUX = ADMUX|1<<REFS0;   //voltage reference selection //avcc aref with external cap
	ADMUX= ADMUX|adchan;	   //enable pin
	ADCSRA = 0;
	ADCSRA =ADCSRA| 1<<ADEN|1<<ADPS2|1<<ADPS1;  ///16Mhz/64 = 250Khz(ADC prescaler) the ADC reference clock (division factor was set to 64 using ADPSn bits) 
	
}
unsigned int readADC(void){    ///read adc values 
	ADCSRA = ADCSRA|1<<ADSC;     //start new conversion
	while(ADCSRA & (1<<ADSC));   ///wait until the conversion is done
	return (ADCL|ADCH<<8);			//returns the adc value of the chosen channel //10bit
}